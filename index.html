<!DOCTYPE html>
<html lang="km">
<head>
<meta charset="UTF-8">
<title>ការត្រួតពិនិត្យគុណភាពគ្រាប់ស្វាយចន្ទី</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<style>
body {
  font-family: "Noto Sans Khmer", "Khmer OS", "Arial Unicode MS", Arial, sans-serif;
  background: #f4f6f8;
  padding: 20px;
}
.container {
  max-width: 750px;
  margin: auto;
  background: #fff;
  padding: 20px 30px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
h1 {
  text-align: center;
  color: #2c3e50;
}
label {
  display: block;
  margin-top: 10px;
  font-weight: bold;
}
input {
  width: 100%;
  padding: 8px;
  margin-top: 5px;
  border: 1px solid #ccc;
  border-radius: 5px;
}
button {
  width: 100%;
  margin-top: 15px;
  padding: 10px;
  background: #007bff;
  color: white;
  font-size: 16px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
}
button:hover { background: #0056b3; }
.result {
  background: #eef3f7;
  padding: 15px;
  border-radius: 8px;
  margin-top: 15px;
}
.loading {
  display: none;
  color: #007bff;
  text-align: center;
  margin: 10px 0;
}
img{
  align-self: start;
  margin-top: -55px;
  margin-left: 65px;
  margin-bottom: 0;
}
h3{
  color: blue;
  margin-bottom: 0; 
}
.nexttext{
  margin-left: 40px;
  margin-top: 0;
}
</style>
</head>

<body>
<div class="container">
  <h1>ការត្រួតពិនិត្យគុណភាពគ្រាប់ស្វាយចន្ទី</h1>

  <label>លេខកូដកសិករ</label>
  <input type="text" id="farmerI">

  <label>ឈ្មោះកសិករ</label>
  <input type="text" id="farmer" >

  <label>កាលបរិច្ឆេទ</label>
  <input type="date" id="date">

  <label>ពូជគ្រាប់ស្វាយចន្ទី</label>
  <input type="text" id="variety">

  <label>ទម្ងន់សំណាកគ្រាប់ស្វាយចន្ទី (ក្រាម)</label>
  <input type="number" id="sampleWeight">

  <label>សំណើម (%)</label>
  <input type="number" id="moisture">

  <label>ចំនួនគ្រាប់ស្វាយចន្ទី (គ្រាប់)</label>
  <input type="number" id="nutsCount">

  <label>កម្ទេចកម្ទីមិនមែនគ្រាប់ស្វាយចន្ទី (ក្រាម)</label>
  <input type="number" id="foreignMatter">

  <label>បរិមាណសាច់ល្អ (ក្រាម)</label>
  <input type="number" id="goodMeat">

  <label>បរិមាណសាច់ចែក (ក្រាម)</label>
  <input type="number" id="brokenMeat">

  <label>ចំនួនគ្រាប់ខូច (គ្រាប់)</label>
  <input type="number" id="badNutsCount">

  <label>បរិមាណគ្រាប់ខូច (ក្រាម)</label>
  <input type="number" id="badNutsWeight">

  <button type="button" onclick="calculate()">គណនា</button>

  <div id="result" class="result"></div>
  
  <div id="loading" class="loading">កំពុងបង្កើត PDF... សូមរង់ចាំ</div>
  <button type="button" onclick="generatePDF()">បង្កើត PDF</button>
</div>

<script>
  let results = {};
  function clearForm() {
  // Clear all input fields
  document.getElementById('farmerId').value = '';
  document.getElementById('farmer').value = '';
  document.getElementById('date').value = '';
  document.getElementById('variety').value = '';
  document.getElementById('sampleWeight').value = '';
  document.getElementById('moisture').value = '';
  document.getElementById('nutsCount').value = '';
  document.getElementById('foreignMatter').value = '';
  document.getElementById('goodMeat').value = '';
  document.getElementById('brokenMeat').value = '';
  document.getElementById('badNutsCount').value = '';
  document.getElementById('badNutsWeight').value = '';
  
  // Clear results display
  document.getElementById('result').innerHTML = '';
  
  // Reset results object
  results = {};
  
  console.log('Form cleared successfully');
}

// Base64 encoded Noto Sans Khmer font (simplified version for demo)
// In production, you would use the complete font file
const khmerFontBase64 = "YOUR_FONT_BASE64_HERE"; // You need to provide actual font

function calculate() {
  const good = parseFloat(document.getElementById("goodMeat").value) || 0;
  const broken = parseFloat(document.getElementById("brokenMeat").value) || 0;

  const totalGood = good + broken / 2;
  const percent = (totalGood * 100) / 1000;

  results = { totalGood, percent };

  document.getElementById("result").innerHTML = `
    <p><b>បរិមាណសាច់ល្អសរុប (ក្រាម):</b> <strong>${totalGood.toFixed(2)}</strong></p>
    <p><b>ផលធៀបសាច់ធៀបនឹងគ្រាប់ស្វាយចន្ទី (%):</b> <strong>${percent.toFixed(2)}%</strong></p>
  `;
}

// Method 1: Using html2canvas to capture Khmer text as image
function generatePDFWithCanvas() {
  const loadingElement = document.getElementById('loading');
  const pdfButton = document.querySelector('button[onclick="generatePDF()"]');
  
  loadingElement.style.display = 'block';
  pdfButton.disabled = true;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Create a temporary div with all the content
  const content = `
    <div style="font-family:  'Khmer OS Muol Light', Arial, sans-serif; padding: 10px;">
      <h3 style="text-align: center;">ព្រះរាជាណាចក្រកម្ពុជា</h3>
      <h3 style="text-align: center;">ជាតិ សាសនា ព្រះមហាក្សត្រ</h3>
      
      <img src="/logo DAI No Background.png" alt="Logo" style="width: 150px; height: auto;">
      <h3 style="text-align: start;">ក្រសួងកសិកម្ម រុក្ខប្រម៉ាញ់ និងនេសាទ</h3>
      <div class="nexttext">
      <h3 style="text-align: start;">នាយកដ្ឋានកសិ-ឧស្សាហកម្ម</h3>
      </div>
      </div>
      
    <div style="font-family: 'Noto Sans Khmer', Arial, sans-serif; padding: 20px;">

      <h2 style="text-align: center;">របាយការណ៍ត្រួតពិនិត្យគុណភាពគ្រាប់ស្វាយចន្ទី</h2>
      
      <p><strong>លេខកូដកសិករ:</strong> ${document.getElementById("farmerId").value || "-"}</p>
      <p><strong>ឈ្មោះកសិករ:</strong> ${document.getElementById("farmer").value || "-"}</p>
      <p><strong>កាលបរិច្ឆេទ:</strong> ${document.getElementById("date").value || "-"}</p>
      <p><strong>ពូជគ្រាប់ស្វាយចន្ទី:</strong> ${document.getElementById("variety").value || "-"}</p>
      <p><strong>ទម្ងន់សំណាកគ្រាប់ស្វាយចន្ទី (ក្រាម):</strong> ${document.getElementById("sampleWeight").value || "-"}</p>
      <p><strong>សំណើម (%):</strong> ${document.getElementById("moisture").value || "-"}</p>
      <p><strong>ចំនួនគ្រាប់ស្វាយចន្ទី (គ្រាប់):</strong> ${document.getElementById("nutsCount").value || "-"}</p>
      <p><strong>កម្ទេចកម្ទីមិនមែនគ្រាប់ស្វាយចន្ទី (ក្រាម):</strong> ${document.getElementById("foreignMatter").value || "-"}</p>
      <p><strong>បរិមាណសាច់ល្អ (ក្រាម):</strong> ${document.getElementById("goodMeat").value || "-"}</p>
      <p><strong>បរិមាណសាច់ចែក (ក្រាម):</strong> ${document.getElementById("brokenMeat").value || "-"}</p>
      <p><strong>ចំនួនគ្រាប់ខូច (គ្រាប់):</strong> ${document.getElementById("badNutsCount").value || "-"}</p>
      <p><strong>បរិមាណគ្រាប់ខូច (ក្រាម):</strong> ${document.getElementById("badNutsWeight").value || "-"}</p>
      
      <p><strong>បរិមាណសាច់ល្អសរុប (ក្រាម):</strong> ${results.totalGood?.toFixed(2) || "0"}</p>
      <p><strong>ផលធៀបសាច់ធៀបនឹងគ្រាប់ស្វាយចន្ទី (%):</strong> ${results.percent?.toFixed(2) || "0"}%</p>
      
      <br><br>
      <p>............................................</p>
      <p>ហត្ថលេខា និងឈ្មោះអ្នកត្រួតពិនិត្យ</p>
    </div>
  `;

  const tempDiv = document.createElement('div');
  tempDiv.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 800px; background: white; padding: 20px; font-family: "Noto Sans Khmer", Arial, sans-serif;';
  tempDiv.innerHTML = content;
  document.body.appendChild(tempDiv);

  // Use html2canvas if available, otherwise fallback
  if (typeof html2canvas !== 'undefined') {
    html2canvas(tempDiv).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const pdfWidth = doc.internal.pageSize.getWidth();
      const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
      
      doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      
      const farmerId = document.getElementById("farmerId").value || "NoID";
      const dateValue = document.getElementById("date").value || "NoDate";
      const fileName = `Cashew_Report_${farmerId}_${dateValue}.pdf`;
      
      doc.save(fileName);
      document.body.removeChild(tempDiv);
      
      loadingElement.style.display = 'none';
      pdfButton.disabled = false;
      clearForm();
      alert('PDF created successfully with Khmer text!');
    });
  } else {
    // Fallback: Load html2canvas from CDN
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
    script.onload = () => generatePDFWithCanvas();
    document.head.appendChild(script);
  }
}

// Method 2: Using custom font with jsPDF
async function generatePDFWithCustomFont() {
  const loadingElement = document.getElementById('loading');
  const pdfButton = document.querySelector('button[onclick="generatePDF()"]');
  
  loadingElement.style.display = 'block';
  pdfButton.disabled = true;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  try {
    
    let y = 20;
    
    // Title
    doc.setFontSize(16);
    doc.text("របាយការណ៍ត្រួតពិនិត្យគុណភាពគ្រាប់ស្វាយចន្ទី", 50, 25);
    
    y = 45;

    const fields = [
      ["លេខកូដកសិករ", "farmerId"],
      ["ឈ្មោះកសិករ", "farmer"],
      ["កាលបរិច្ឆេទ", "date"],
      ["ពូជគ្រាប់ស្វាយចន្ទី", "variety"],
      ["ទម្ងន់សំណាកគ្រាប់ស្វាយចន្ទី (ក្រាម)", "sampleWeight"],
      ["សំណើម (%)", "moisture"],
      ["ចំនួនគ្រាប់ស្វាយចន្ទី (គ្រាប់)", "nutsCount"],
      ["កម្ទេចកម្ទីមិនមែនគ្រាប់ស្វាយចន្ទី (ក្រាម)", "foreignMatter"],
      ["បរិមាណសាច់ល្អ (ក្រាម)", "goodMeat"],
      ["បរិមាណសាច់ចែក (ក្រាម)", "brokenMeat"],
      ["ចំនួនគ្រាប់ខូច (គ្រាប់)", "badNutsCount"],
      ["បរិមាណគ្រាប់ខូច (ក្រាម)", "badNutsWeight"]
    ];

    doc.setFontSize(10);
    for (const [label, id] of fields) {
      const value = document.getElementById(id).value || "-";
      doc.text(`${label}: ${value}`, 20, y);
      y += 8;
    }

    y += 5;
    doc.text(`បរិមាណសាច់ល្អសរុប (ក្រាម): ${results.totalGood?.toFixed(2) || "0"}`, 20, y);
    y += 8;
    doc.text(`ផលធៀបសាច់ធៀបនឹងគ្រាប់ស្វាយចន្ទី (%): ${results.percent?.toFixed(2) || "0"}%`, 20, y);
    
    const farmerId = document.getElementById("farmerId").value || "NoID";
    const dateValue = document.getElementById("date").value || "NoDate";
    const fileName = `Cashew_Report_${farmerId}_${dateValue}.pdf`;
    
    doc.save(fileName);


    

    
  } catch (error) {
    console.error('Error with custom font:', error);
    // Fallback to canvas method
    generatePDFWithCanvas();
  } finally {
    loadingElement.style.display = 'none';
    pdfButton.disabled = false;
  }
}

// Main PDF generation function
function generatePDF() {
// Try the canvas method first (most reliable for Khmer text)
  generatePDFWithCanvas();
}

// Initialize calculation
calculate();

// Load html2canvas for better Khmer text support
const html2canvasScript = document.createElement('script');
html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
document.head.appendChild(html2canvasScript);
</script>
</body>
</html>